<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Erie County Comps Tool</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Mono:wght@400;500&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
  :root {
    --navy: #0a1628; --navy2: #112240; --navy3: #1a3260;
    --gold: #c9a84c; --gold-light: #e8c97a;
    --cream: #f5f0e8; --cream2: #ede8dc;
    --red: #c0392b; --green: #1e7d45;
    --text: #1a1a2e; --muted: #6b7a99; --border: #d4cfc3;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'DM Sans', sans-serif; background: var(--cream); color: var(--text); min-height: 100vh; }

  header { background: var(--navy); padding: 0 40px; display: flex; align-items: center; justify-content: space-between; height: 72px; border-bottom: 3px solid var(--gold); }
  .logo { display: flex; align-items: baseline; gap: 12px; }
  .logo-text { font-family: 'Bebas Neue', sans-serif; font-size: 28px; color: #fff; letter-spacing: 2px; }
  .logo-sub { font-family: 'DM Mono', monospace; font-size: 10px; color: var(--gold); letter-spacing: 3px; text-transform: uppercase; }
  .header-badge { font-family: 'DM Mono', monospace; font-size: 10px; color: var(--gold); letter-spacing: 2px; border: 1px solid var(--gold); padding: 4px 10px; border-radius: 2px; }

  .container { max-width: 1200px; margin: 0 auto; padding: 40px 32px; }

  .step-card { background: #fff; border: 1px solid var(--border); border-radius: 4px; margin-bottom: 24px; overflow: hidden; transition: box-shadow 0.2s; }
  .step-card.active { box-shadow: 0 4px 24px rgba(10,22,40,0.12); border-color: var(--navy3); }
  .step-header { background: var(--navy); color: #fff; padding: 16px 28px; display: flex; align-items: center; gap: 16px; }
  .step-num { font-family: 'Bebas Neue', sans-serif; font-size: 32px; color: var(--gold); line-height: 1; min-width: 30px; }
  .step-title { font-size: 14px; font-weight: 600; letter-spacing: 1.5px; text-transform: uppercase; }
  .step-desc { font-size: 12px; color: var(--muted); margin-top: 2px; font-family: 'DM Mono', monospace; }
  .step-body { padding: 28px; }

  .upload-zone { border: 2px dashed var(--border); border-radius: 4px; padding: 48px 32px; text-align: center; cursor: pointer; transition: all 0.2s; background: var(--cream); }
  .upload-zone:hover, .upload-zone.dragover { border-color: var(--gold); background: #fff; }
  .upload-icon { font-size: 40px; margin-bottom: 12px; }
  .upload-text { font-size: 15px; font-weight: 500; color: var(--navy); margin-bottom: 6px; }
  .upload-hint { font-family: 'DM Mono', monospace; font-size: 11px; color: var(--muted); }
  .upload-success { background: #f0faf4; border-color: var(--green); color: var(--green); }

  .mapper-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
  .mapper-row { display: flex; align-items: center; gap: 12px; }
  .mapper-label { font-family: 'DM Mono', monospace; font-size: 11px; color: var(--muted); text-transform: uppercase; letter-spacing: 1px; min-width: 110px; }
  .mapper-label span { color: var(--red); }

  select, input[type="text"], input[type="number"] { font-family: 'DM Sans', sans-serif; font-size: 13px; border: 1px solid var(--border); border-radius: 3px; padding: 8px 12px; background: #fff; color: var(--text); width: 100%; transition: border-color 0.15s; }
  select:focus, input:focus { outline: none; border-color: var(--navy3); }

  .subject-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 16px; }
  .field-group label { display: block; font-family: 'DM Mono', monospace; font-size: 10px; color: var(--muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 6px; }
  .field-group label span { color: var(--red); }

  .filter-bar { display: flex; gap: 16px; flex-wrap: wrap; align-items: flex-end; }
  .filter-bar .field-group { flex: 1; min-width: 140px; }

  .btn { font-family: 'Bebas Neue', sans-serif; font-size: 18px; letter-spacing: 2px; padding: 14px 36px; border: none; border-radius: 3px; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; gap: 8px; }
  .btn-primary { background: var(--navy); color: #fff; }
  .btn-primary:hover { background: var(--navy3); transform: translateY(-1px); box-shadow: 0 4px 12px rgba(10,22,40,0.3); }
  .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
  .btn-gold { background: var(--gold); color: var(--navy); }
  .btn-gold:hover { background: var(--gold-light); transform: translateY(-1px); }
  .btn-sm { font-size: 13px; padding: 8px 18px; font-family: 'DM Sans', sans-serif; font-weight: 600; letter-spacing: 0.5px; }

  /* GEOCODING PROGRESS */
  .geo-progress-wrap { margin-top: 20px; display: none; }
  .geo-progress-wrap.visible { display: block; }
  .geo-label { font-family: 'DM Mono', monospace; font-size: 11px; color: var(--navy); margin-bottom: 8px; display: flex; justify-content: space-between; }
  .geo-bar-track { background: var(--cream2); border-radius: 2px; height: 6px; overflow: hidden; }
  .geo-bar-fill { background: var(--gold); height: 100%; border-radius: 2px; transition: width 0.3s ease; width: 0%; }
  .geo-detail { font-family: 'DM Mono', monospace; font-size: 10px; color: var(--muted); margin-top: 6px; min-height: 14px; }

  /* RESULTS */
  .results-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 12px; }
  .results-title { font-family: 'Bebas Neue', sans-serif; font-size: 22px; letter-spacing: 1.5px; color: var(--navy); }

  .subject-summary { background: var(--navy); color: #fff; border-radius: 4px; padding: 20px 28px; margin-bottom: 24px; display: flex; gap: 32px; flex-wrap: wrap; align-items: center; }
  .subj-address { font-family: 'Bebas Neue', sans-serif; font-size: 20px; letter-spacing: 1px; flex: 1; min-width: 200px; }
  .subj-stat { text-align: center; }
  .subj-stat-val { font-family: 'Bebas Neue', sans-serif; font-size: 22px; color: var(--gold); display: block; }
  .subj-stat-label { font-family: 'DM Mono', monospace; font-size: 9px; color: var(--muted); text-transform: uppercase; letter-spacing: 1px; }

  .stats-row { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 14px; margin-bottom: 24px; }
  .stat-box { background: #fff; border: 1px solid var(--border); border-radius: 4px; padding: 16px 20px; text-align: center; }
  .stat-box-val { font-family: 'Bebas Neue', sans-serif; font-size: 26px; color: var(--navy); display: block; }
  .stat-box-label { font-family: 'DM Mono', monospace; font-size: 10px; color: var(--muted); text-transform: uppercase; letter-spacing: 1px; margin-top: 2px; }

  .table-wrap { overflow-x: auto; border-radius: 4px; border: 1px solid var(--border); }
  table { width: 100%; border-collapse: collapse; font-size: 13px; }
  thead { background: var(--navy2); color: #fff; }
  th { font-family: 'DM Mono', monospace; font-size: 10px; text-transform: uppercase; letter-spacing: 1px; padding: 12px 16px; text-align: left; white-space: nowrap; cursor: pointer; user-select: none; }
  th:hover { background: var(--navy3); }
  th .sort-arrow { margin-left: 4px; opacity: 0.5; }
  th.sorted .sort-arrow { opacity: 1; color: var(--gold); }
  tbody tr { border-bottom: 1px solid var(--cream2); transition: background 0.1s; }
  tbody tr:hover { background: var(--cream); }
  tbody tr:last-child { border-bottom: none; }
  td { padding: 11px 16px; white-space: nowrap; }
  td.address-cell { white-space: normal; min-width: 180px; }

  .badge { font-family: 'DM Mono', monospace; font-size: 10px; padding: 3px 8px; border-radius: 2px; letter-spacing: 0.5px; }
  .badge-green { background: #d4edda; color: var(--green); }
  .badge-red { background: #fde8e7; color: var(--red); }
  .badge-muted { background: var(--cream2); color: var(--muted); }
  .badge-gold { background: #fdf3dc; color: #8a6a1a; }

  .diff-positive { color: var(--green); font-weight: 600; }
  .diff-negative { color: var(--red); font-weight: 600; }

  .dist-close { color: var(--green); font-weight: 600; }
  .dist-mid { color: #b07d2a; font-weight: 500; }
  .dist-far { color: var(--muted); }

  .info-box { background: #eef3ff; border-left: 3px solid var(--navy3); padding: 12px 16px; border-radius: 0 3px 3px 0; font-size: 13px; color: var(--navy); margin-bottom: 20px; }
  .info-box a { color: var(--navy3); font-weight: 600; }
  .warn-box { background: #fff8e1; border-left: 3px solid var(--gold); padding: 12px 16px; border-radius: 0 3px 3px 0; font-size: 12px; color: #7a5c00; margin-top: 12px; font-family: 'DM Mono', monospace; }

  .divider { border: none; border-top: 1px solid var(--border); margin: 24px 0; }
  .hidden { display: none !important; }
  .tag-row { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 16px; }
  .tag { font-family: 'DM Mono', monospace; font-size: 10px; padding: 4px 10px; background: var(--cream2); border-radius: 2px; color: var(--muted); letter-spacing: 0.5px; }

  @media print {
    header, .step-card, .btn, .filter-bar, .tag-row { display: none !important; }
    .print-header { display: block; margin-bottom: 24px; }
    .print-header h1 { font-family: 'Bebas Neue', sans-serif; font-size: 28px; letter-spacing: 2px; }
    .print-header p { font-size: 12px; color: #666; font-family: 'DM Mono', monospace; }
    body { background: #fff; }
  }
  .print-header { display: none; }
</style>
</head>
<body>

<header>
  <div class="logo">
    <span class="logo-text">Erie Comps</span>
    <span class="logo-sub">Erie County, NY ¬∑ Real Estate Analysis</span>
  </div>
  <span class="header-badge">NYS ORPTS DATA</span>
</header>

<div class="container">

  <!-- STEP 1: Upload -->
  <div class="step-card active" id="card-upload">
    <div class="step-header">
      <span class="step-num">01</span>
      <div>
        <div class="step-title">Load Sales Data</div>
        <div class="step-desc">Upload your Erie County sales export (CSV or TSV)</div>
      </div>
    </div>
    <div class="step-body">
      <div class="info-box">
        üì• <strong>Where to get data:</strong> Go to <a href="https://www.tax.ny.gov/pit/property/munidataportal.htm" target="_blank">tax.ny.gov ‚Üí Municipal Data Portal ‚Üí Sales Web</a> ‚Üí Select Erie County ‚Üí Choose municipality & date range ‚Üí Export/Download CSV. Refresh monthly for fresh comps.
      </div>
      <div class="upload-zone" id="upload-zone">
        <div class="upload-icon">üìÇ</div>
        <div class="upload-text">Drop your CSV file here, or click to browse</div>
        <div class="upload-hint">Accepts .csv, .tsv, or .txt exports from NYS SalesWeb</div>
        <input type="file" id="file-input" accept=".csv,.tsv,.txt" style="display:none">
      </div>
      <div id="upload-status" class="hidden" style="margin-top:16px; font-family:'DM Mono',monospace; font-size:12px; color:var(--green)"></div>
      <div id="col-mapper" class="hidden">
        <hr class="divider">
        <div style="margin-bottom:16px;">
          <div style="font-weight:600; font-size:14px; margin-bottom:4px;">Map Your Columns</div>
          <div style="font-family:'DM Mono',monospace; font-size:11px; color:var(--muted);">Tell us which columns contain each data field. We've auto-detected where possible.</div>
        </div>
        <div class="mapper-grid" id="mapper-grid"></div>
        <div style="margin-top:20px;">
          <button class="btn btn-primary" onclick="confirmMapping()">Confirm Mapping ‚Üí</button>
        </div>
      </div>
    </div>
  </div>

  <!-- STEP 2: Subject Property -->
  <div class="step-card" id="card-subject">
    <div class="step-header">
      <span class="step-num">02</span>
      <div>
        <div class="step-title">Subject Property</div>
        <div class="step-desc">Enter the property you're evaluating</div>
      </div>
    </div>
    <div class="step-body">
      <div class="subject-grid">
        <div class="field-group" style="grid-column: span 2">
          <label>Street Address <span>*</span></label>
          <input type="text" id="subj-address" placeholder="e.g. 123 Elmwood Ave" />
        </div>
        <div class="field-group">
          <label>City / Town <span>*</span></label>
          <input type="text" id="subj-city" placeholder="e.g. Buffalo" />
        </div>
        <div class="field-group">
          <label>Property Type</label>
          <select id="subj-type">
            <option value="">Any</option>
            <option value="210">210 - Single Family</option>
            <option value="215">215 - 2 Family</option>
            <option value="220">220 - 3 Family</option>
            <option value="230">230 - Apartments</option>
            <option value="240">240 - Rural Res</option>
            <option value="250">250 - Comm/Res</option>
            <option value="270">270 - Mobile Home</option>
            <option value="280">280 - Seasonal</option>
          </select>
        </div>
        <div class="field-group">
          <label>Sq Ft (if known)</label>
          <input type="number" id="subj-sqft" placeholder="e.g. 1450" />
        </div>
        <div class="field-group">
          <label>Bedrooms</label>
          <input type="number" id="subj-beds" placeholder="e.g. 3" />
        </div>
        <div class="field-group">
          <label>Bathrooms</label>
          <input type="number" id="subj-baths" placeholder="e.g. 1.5" step="0.5" />
        </div>
        <div class="field-group">
          <label>List / Asking Price</label>
          <input type="number" id="subj-price" placeholder="e.g. 225000" />
        </div>
      </div>
    </div>
  </div>

  <!-- STEP 3: Filters -->
  <div class="step-card" id="card-filters">
    <div class="step-header">
      <span class="step-num">03</span>
      <div>
        <div class="step-title">Comp Filters</div>
        <div class="step-desc">Narrow the comparable sales search</div>
      </div>
    </div>
    <div class="step-body">
      <div class="filter-bar">
        <div class="field-group">
          <label>Months Back</label>
          <select id="filter-months">
            <option value="6">Last 6 months</option>
            <option value="12" selected>Last 12 months</option>
            <option value="18">Last 18 months</option>
            <option value="24">Last 24 months</option>
            <option value="0">All dates</option>
          </select>
        </div>
        <div class="field-group">
          <label>Search Radius</label>
          <select id="filter-radius">
            <option value="0.1">~1 block (0.1 mi)</option>
            <option value="0.25" selected>~3 blocks (0.25 mi)</option>
            <option value="0.5">~5 blocks (0.5 mi)</option>
            <option value="1.0">1 mile</option>
            <option value="2.0">2 miles</option>
            <option value="0">No radius limit</option>
          </select>
        </div>
        <div class="field-group">
          <label>Max Comps to Show</label>
          <select id="filter-count">
            <option value="5">5 comps</option>
            <option value="10" selected>10 comps</option>
            <option value="20">20 comps</option>
            <option value="999">All matching</option>
          </select>
        </div>
        <div class="field-group">
          <label>Min Sale Price ($)</label>
          <input type="number" id="filter-min" placeholder="e.g. 50000" />
        </div>
        <div class="field-group">
          <label>Max Sale Price ($)</label>
          <input type="number" id="filter-max" placeholder="e.g. 500000" />
        </div>
      </div>

      <div class="warn-box">
        ‚ö° <strong>Geocoding note:</strong> The tool uses the US Census Bureau geocoder with automatic fallback to OpenStreetMap for better Buffalo/Erie County coverage. It processes comps in batches ‚Äî larger datasets take 20‚Äì60 seconds. Results are cached so re-runs are instant.
      </div>

      <!-- Geocoding progress -->
      <div class="geo-progress-wrap" id="geo-progress">
        <hr class="divider" style="margin-top:16px">
        <div class="geo-label">
          <span id="geo-label-text">Geocoding addresses...</span>
          <span id="geo-pct">0%</span>
        </div>
        <div class="geo-bar-track"><div class="geo-bar-fill" id="geo-bar"></div></div>
        <div class="geo-detail" id="geo-detail"></div>
      </div>

      <div style="margin-top:24px; display:flex; gap:12px; align-items:center;">
        <button class="btn btn-primary" id="run-btn" onclick="runComps()" style="font-size:20px; padding:16px 48px;">Generate Comps Sheet</button>
        <span id="run-status" style="font-family:'DM Mono',monospace; font-size:11px; color:var(--muted);"></span>
      </div>
    </div>
  </div>

  <!-- RESULTS -->
  <div id="results-section" class="hidden">
    <div class="print-header">
      <h1>Comparable Sales Report ‚Äî Erie County, NY</h1>
      <p id="print-meta"></p>
    </div>
    <div class="results-header">
      <span class="results-title">Comparable Sales Report</span>
      <div style="display:flex; gap:10px;">
        <button class="btn btn-sm btn-gold" onclick="window.print()">üñ® Print / Save PDF</button>
        <button class="btn btn-sm btn-primary" onclick="exportCSV()">‚¨á Export CSV</button>
      </div>
    </div>
    <div class="subject-summary" id="subject-summary"></div>
    <div class="stats-row" id="stats-row"></div>
    <div class="tag-row" id="tag-row"></div>
    <div class="table-wrap">
      <table id="comps-table">
        <thead><tr id="table-head"></tr></thead>
        <tbody id="table-body"></tbody>
      </table>
    </div>
    <div style="margin-top:12px; font-family:'DM Mono',monospace; font-size:10px; color:var(--muted);">
      Source: NYS ORPTS SalesWeb ¬∑ Geocoding: US Census Bureau ¬∑ Arms-length sales only ¬∑ Generated <span id="gen-date"></span>
    </div>
  </div>

</div>

<script>
// ‚îÄ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let rawRows = [], headers = [], colMap = {};
let sortCol = null, sortDir = 1;
const geoCache = {}; // address ‚Üí {lat, lon} or null

// ‚îÄ‚îÄ‚îÄ FIELD DEFINITIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const FIELDS = [
  { key: 'street_num',  label: 'Street Number', required: true,  aliases: ['street number','str num','strnum','house number','house no','prop num','property number','st num','number','stno','street no','prop no'] },
  { key: 'street_name', label: 'Street Name',   required: true,  aliases: ['street name','str name','strname','street','road','road name','prop name','property name','st name','name','stname'] },
  { key: 'city',        label: 'City / Town',   required: true,  aliases: ['city','town','municipality','muni','city or town','city/town'] },
  { key: 'sale_price',  label: 'Sale Price',    required: true,  aliases: ['sale price','price','full sale price','amount','sale amt','sales price','transfer price'] },
  { key: 'sale_date',   label: 'Sale Date',     required: false, aliases: ['sale date','date of sale','transfer date','recorded date','deed date','date'] },
  { key: 'prop_class',  label: 'Property Class',required: false, aliases: ['property class','prop class','class code','class','propclass','use code','prop_class_last_roll'] },
  { key: 'sqft',        label: 'Square Feet',   required: false, aliases: ['sq ft','sqft','square feet','gross sq ft','living area','floor area','building sq ft','land sqft','gla'] },
  { key: 'beds',        label: 'Bedrooms',      required: false, aliases: ['bedrooms','beds','bedroom','br'] },
  { key: 'baths',       label: 'Bathrooms',     required: false, aliases: ['bathrooms','baths','bath','full bath','total bath'] },
];

// ‚îÄ‚îÄ‚îÄ UPLOAD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const zone = document.getElementById('upload-zone');
const fileInput = document.getElementById('file-input');
zone.addEventListener('click', () => fileInput.click());
zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('dragover'); });
zone.addEventListener('dragleave', () => zone.classList.remove('dragover'));
zone.addEventListener('drop', e => { e.preventDefault(); zone.classList.remove('dragover'); handleFile(e.dataTransfer.files[0]); });
fileInput.addEventListener('change', () => handleFile(fileInput.files[0]));

function handleFile(file) {
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => parseCSV(e.target.result, file.name);
  reader.readAsText(file);
}

function parseCSV(text, name) {
  const firstLine = text.split('\n')[0];
  const delimiter = firstLine.includes('\t') ? '\t' : ',';
  const lines = text.trim().split('\n').filter(l => l.trim());
  if (lines.length < 2) { alert('File appears empty.'); return; }
  headers = parseRow(lines[0], delimiter);
  rawRows = lines.slice(1).map(l => {
    const vals = parseRow(l, delimiter);
    const obj = {};
    headers.forEach((h, i) => obj[h] = (vals[i] || '').trim());
    return obj;
  }).filter(r => Object.values(r).some(v => v));
  document.getElementById('upload-status').textContent = `‚úì Loaded ${rawRows.length.toLocaleString()} rows from "${name}"`;
  document.getElementById('upload-status').classList.remove('hidden');
  zone.classList.add('upload-success');
  zone.innerHTML = `<div class="upload-icon">‚úÖ</div><div class="upload-text">${name}</div><div class="upload-hint">${rawRows.length.toLocaleString()} sales records loaded</div>`;
  buildMapper();
}

function parseRow(line, delim) {
  const result = []; let cur = '', inQ = false;
  for (let i = 0; i < line.length; i++) {
    const ch = line[i];
    if (ch === '"') { inQ = !inQ; continue; }
    if (ch === delim && !inQ) { result.push(cur); cur = ''; continue; }
    cur += ch;
  }
  result.push(cur);
  return result;
}

// ‚îÄ‚îÄ‚îÄ COLUMN MAPPER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function autoDetect(field) {
  for (const h of headers) {
    const hn = h.toLowerCase().trim();
    if (field.aliases.some(a => hn === a || hn.includes(a) || a.includes(hn))) return h;
  }
  return '';
}

function buildMapper() {
  const grid = document.getElementById('mapper-grid');
  grid.innerHTML = '';
  FIELDS.forEach(f => {
    const detected = autoDetect(f);
    const row = document.createElement('div');
    row.className = 'mapper-row';
    row.innerHTML = `
      <div class="mapper-label">${f.label}${f.required ? ' <span>*</span>' : ''}</div>
      <select id="map-${f.key}">
        <option value="">-- not in file --</option>
        ${headers.map(h => `<option value="${h}" ${h === detected ? 'selected' : ''}>${h}</option>`).join('')}
      </select>`;
    grid.appendChild(row);
  });
  document.getElementById('col-mapper').classList.remove('hidden');
}

function confirmMapping() {
  colMap = {};
  const missing = [];
  FIELDS.forEach(f => {
    const val = document.getElementById(`map-${f.key}`).value;
    colMap[f.key] = val || null;
    if (f.required && !val) missing.push(f.label);
  });
  if (missing.length) { alert(`Please map required fields: ${missing.join(', ')}`); return; }
  document.getElementById('card-subject').classList.add('active');
  document.getElementById('card-filters').classList.add('active');
  document.getElementById('card-upload').classList.remove('active');
  document.getElementById('col-mapper').classList.add('hidden');
  document.getElementById('upload-status').textContent += ' ¬∑ Columns mapped ‚úì';
}

// ‚îÄ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function getVal(row, key) {
  const col = colMap[key];
  return col ? (row[col] || '') : '';
}

function getFullStreet(row) {
  const num = getVal(row, 'street_num').trim();
  const name = getVal(row, 'street_name').trim();
  return [num, name].filter(Boolean).join(' ');
}

function parsePrice(v) {
  return parseFloat(v.toString().replace(/[$,\s]/g, '')) || 0;
}

function parseDate(v) {
  if (!v) return null;
  const d = new Date(v);
  if (!isNaN(d)) return d;
  const m = v.match(/(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})/);
  if (m) return new Date(`${m[3]}-${m[1].padStart(2,'0')}-${m[2].padStart(2,'0')}`);
  return null;
}

function normalizeCity(s) {
  return s.toLowerCase().replace(/\btown of\b|\bcity of\b|\bvillage of\b/gi, '').trim();
}

function fmt$(n) {
  if (!n || isNaN(n)) return '-';
  return '$' + Math.round(n).toLocaleString();
}

function fmtDate(v) {
  const d = parseDate(v);
  if (!d) return v || '-';
  return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
}

function median(arr) {
  if (!arr.length) return 0;
  const s = [...arr].sort((a, b) => a - b);
  const m = Math.floor(s.length / 2);
  return s.length % 2 ? s[m] : (s[m - 1] + s[m]) / 2;
}

// ‚îÄ‚îÄ‚îÄ HAVERSINE DISTANCE (miles) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function haversine(lat1, lon1, lat2, lon2) {
  const R = 3958.8; // Earth radius in miles
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) * Math.sin(dLon/2)**2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
}

// ‚îÄ‚îÄ‚îÄ GEOCODING (US Census Bureau) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function geocodeSingle(address, city, state = 'NY') {
  const key = `${address}|${city}|${state}`.toLowerCase();
  if (geoCache[key] !== undefined) return geoCache[key];

  // Try 1: US Census Bureau
  try {
    const query = encodeURIComponent(`${address}, ${city}, ${state}`);
    const url = `https://geocoding.geo.census.gov/geocoder/locations/onelineaddress?address=${query}&benchmark=Public_AR_Current&format=json`;
    const res = await fetch(url);
    const data = await res.json();
    const matches = data?.result?.addressMatches;
    if (matches && matches.length > 0) {
      const { x: lon, y: lat } = matches[0].coordinates;
      geoCache[key] = { lat, lon };
      return { lat, lon };
    }
  } catch (e) {}

  // Try 2: Nominatim (OpenStreetMap) ‚Äî better coverage for Buffalo/Erie County
  try {
    const query = encodeURIComponent(`${address}, ${city}, ${state}, USA`);
    const url = `https://nominatim.openstreetmap.org/search?q=${query}&format=json&limit=1&countrycodes=us`;
    const res = await fetch(url, { headers: { 'Accept-Language': 'en', 'User-Agent': 'ErieComps/1.0' } });
    const data = await res.json();
    if (data && data.length > 0) {
      const { lat, lon } = data[0];
      const result = { lat: parseFloat(lat), lon: parseFloat(lon) };
      geoCache[key] = result;
      return result;
    }
  } catch (e) {}

  geoCache[key] = null;
  return null;
}

// Batch geocode with progress updates
async function geocodeBatch(rows, onProgress) {
  const results = [];
  const BATCH_DELAY = 80; // ms between requests to be polite to the API

  for (let i = 0; i < rows.length; i++) {
    const row = rows[i];
    const addr = getFullStreet(row);
    const city = getVal(row, 'city');
    const coords = await geocodeSingle(addr, city);
    results.push(coords);
    if (onProgress) onProgress(i + 1, rows.length, addr);
    // Small delay to avoid hammering the Census API
    await new Promise(r => setTimeout(r, BATCH_DELAY));
  }
  return results;
}

// ‚îÄ‚îÄ‚îÄ MAIN COMPS RUNNER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function runComps() {
  const subjAddr = document.getElementById('subj-address').value.trim();
  const subjCity = document.getElementById('subj-city').value.trim();
  const subjType = document.getElementById('subj-type').value;
  const subjSqft = parseFloat(document.getElementById('subj-sqft').value) || 0;
  const subjBeds = parseFloat(document.getElementById('subj-beds').value) || 0;
  const subjBaths = parseFloat(document.getElementById('subj-baths').value) || 0;
  const subjPrice = parseFloat(document.getElementById('subj-price').value) || 0;

  if (!subjAddr || !subjCity) { alert('Please enter a subject property address and city/town.'); return; }

  const months = parseInt(document.getElementById('filter-months').value);
  const radiusMi = parseFloat(document.getElementById('filter-radius').value);
  const maxCount = parseInt(document.getElementById('filter-count').value);
  const minPrice = parseFloat(document.getElementById('filter-min').value) || 0;
  const maxPrice = parseFloat(document.getElementById('filter-max').value) || Infinity;
  const useRadius = radiusMi > 0;

  const cutoff = months > 0 ? new Date(Date.now() - months * 30.5 * 24 * 3600 * 1000) : null;

  // Disable button
  const btn = document.getElementById('run-btn');
  btn.disabled = true;
  btn.textContent = 'Working...';
  document.getElementById('run-status').textContent = '';

  // Show progress bar
  const progressWrap = document.getElementById('geo-progress');

  try {
    // STEP 1: Pre-filter by date, price, type (before geocoding to reduce API calls)
    let candidates = rawRows.filter(row => {
      const price = parsePrice(getVal(row, 'sale_price'));
      if (price <= 0 || price < minPrice || price > maxPrice) return false;
      if (cutoff) {
        const d = parseDate(getVal(row, 'sale_date'));
        if (d && d < cutoff) return false;
      }
      if (subjType) {
        const pc = getVal(row, 'prop_class').toString().trim();
        if (pc && !pc.startsWith(subjType.substring(0, 2))) return false;
      }
      return true;
    });

    // STEP 2: Geocode subject property
    document.getElementById('geo-label-text').textContent = 'Geocoding subject property...';
    document.getElementById('geo-pct').textContent = '';
    document.getElementById('geo-detail').textContent = `${subjAddr}, ${subjCity}`;
    progressWrap.classList.add('visible');
    document.getElementById('geo-bar').style.width = '5%';

    const subjCoords = await geocodeSingle(subjAddr, subjCity);
    if (useRadius && !subjCoords) {
      alert(`Both geocoders failed for "${subjAddr}, ${subjCity}, NY". Try a slightly different address format (e.g. "78 Manchester Pl" instead of "Place") or disable the radius filter.`);
      return;
    }

    // STEP 3: Geocode candidates (only if radius filtering is on)
    let comps = [];
    if (useRadius && subjCoords) {
      document.getElementById('geo-label-text').textContent = 'Geocoding comparable sales...';

      // Filter to same city/town first to reduce geocoding load
      const subjCityNorm = normalizeCity(subjCity);
      const cityFiltered = candidates.filter(row => {
        const city = normalizeCity(getVal(row, 'city'));
        return city.includes(subjCityNorm) || subjCityNorm.includes(city);
      });

      const toGeocode = cityFiltered;
      document.getElementById('geo-detail').textContent = `0 of ${toGeocode.length} addresses`;

      const coords = await geocodeBatch(toGeocode, (done, total, addr) => {
        const pct = Math.round((done / total) * 100);
        document.getElementById('geo-bar').style.width = `${5 + pct * 0.9}%`;
        document.getElementById('geo-pct').textContent = `${pct}%`;
        document.getElementById('geo-detail').textContent = `${done} of ${total} ¬∑ ${addr}`;
      });

      // Filter by radius and attach distance
      toGeocode.forEach((row, i) => {
        if (coords[i]) {
          const dist = haversine(subjCoords.lat, subjCoords.lon, coords[i].lat, coords[i].lon);
          if (dist <= radiusMi) {
            comps.push({ ...row, _dist: dist, _coords: coords[i] });
          }
        }
        // If geocoding failed, skip row (can't verify distance)
      });

    } else {
      // No radius ‚Äî just use all candidates (same city filter)
      const subjCityNorm = normalizeCity(subjCity);
      comps = candidates.filter(row => {
        const city = normalizeCity(getVal(row, 'city'));
        return city.includes(subjCityNorm) || subjCityNorm.includes(city);
      }).map(row => ({ ...row, _dist: null }));
    }

    // Sort by distance (closest first), then date
    comps.sort((a, b) => {
      if (a._dist !== null && b._dist !== null) return a._dist - b._dist;
      const da = parseDate(getVal(a, 'sale_date'));
      const db = parseDate(getVal(b, 'sale_date'));
      if (da && db) return db - da;
      return 0;
    });

    comps = comps.slice(0, maxCount);

    document.getElementById('geo-bar').style.width = '100%';
    document.getElementById('geo-pct').textContent = '100%';
    document.getElementById('geo-label-text').textContent = 'Geocoding complete ‚úì';
    document.getElementById('geo-detail').textContent = `${comps.length} comps found within ${radiusMi > 0 ? radiusMi + ' mi' : 'area'}`;

    if (comps.length === 0) {
      alert(`No comps found within ${radiusMi} miles. Try a larger radius or longer date range.`);
      return;
    }

    renderResults(comps, { subjAddr, subjCity, subjType, subjSqft, subjBeds, subjBaths, subjPrice, subjCoords, radiusMi });

  } finally {
    btn.disabled = false;
    btn.textContent = 'Generate Comps Sheet';
  }
}

// ‚îÄ‚îÄ‚îÄ RENDER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderResults(comps, subj) {
  document.getElementById('results-section').classList.remove('hidden');
  document.getElementById('results-section').scrollIntoView({ behavior: 'smooth', block: 'start' });
  document.getElementById('gen-date').textContent = new Date().toLocaleDateString();
  document.getElementById('print-meta').textContent = `Subject: ${subj.subjAddr}, ${subj.subjCity} ¬∑ Radius: ${subj.radiusMi > 0 ? subj.radiusMi + ' mi' : 'No limit'} ¬∑ Generated ${new Date().toLocaleDateString()}`;

  const prices = comps.map(r => parsePrice(getVal(r, 'sale_price'))).filter(p => p > 0);
  const avgPrice = prices.reduce((a, b) => a + b, 0) / prices.length;
  const medPrice = median(prices);
  const minP = Math.min(...prices);
  const maxP = Math.max(...prices);

  const ppsfArr = comps.filter(r => {
    const p = parsePrice(getVal(r, 'sale_price')), s = parseFloat(getVal(r, 'sqft'));
    return p > 0 && s > 0;
  }).map(r => parsePrice(getVal(r, 'sale_price')) / parseFloat(getVal(r, 'sqft')));
  const avgPpsf = ppsfArr.length ? ppsfArr.reduce((a, b) => a + b, 0) / ppsfArr.length : 0;
  const subjPpsf = subj.subjSqft > 0 && subj.subjPrice > 0 ? subj.subjPrice / subj.subjSqft : 0;

  const hasDistances = comps.some(r => r._dist !== null);

  // Subject bar
  document.getElementById('subject-summary').innerHTML = `
    <div class="subj-address">${subj.subjAddr}<br>
      <span style="font-size:13px;font-family:'DM Mono',monospace;color:var(--muted);font-weight:300">${subj.subjCity}, Erie County NY</span>
      ${subj.subjCoords ? `<br><span style="font-size:10px;font-family:'DM Mono',monospace;color:var(--muted)">üìç ${subj.subjCoords.lat.toFixed(5)}, ${subj.subjCoords.lon.toFixed(5)}</span>` : ''}
    </div>
    ${subj.radiusMi > 0 ? `<div class="subj-stat"><span class="subj-stat-val">${subj.radiusMi} mi</span><span class="subj-stat-label">Search Radius</span></div>` : ''}
    ${subj.subjPrice > 0 ? `<div class="subj-stat"><span class="subj-stat-val">${fmt$(subj.subjPrice)}</span><span class="subj-stat-label">List Price</span></div>` : ''}
    ${subj.subjSqft > 0 ? `<div class="subj-stat"><span class="subj-stat-val">${subj.subjSqft.toLocaleString()}</span><span class="subj-stat-label">Sq Ft</span></div>` : ''}
    ${subjPpsf > 0 ? `<div class="subj-stat"><span class="subj-stat-val">${fmt$(subjPpsf)}</span><span class="subj-stat-label">$/Sq Ft</span></div>` : ''}
    ${subj.subjBeds > 0 ? `<div class="subj-stat"><span class="subj-stat-val">${subj.subjBeds}</span><span class="subj-stat-label">Beds</span></div>` : ''}
    ${subj.subjBaths > 0 ? `<div class="subj-stat"><span class="subj-stat-val">${subj.subjBaths}</span><span class="subj-stat-label">Baths</span></div>` : ''}
  `;

  // Stats
  document.getElementById('stats-row').innerHTML = `
    <div class="stat-box"><span class="stat-box-val">${comps.length}</span><span class="stat-box-label">Comps Found</span></div>
    <div class="stat-box"><span class="stat-box-val">${fmt$(medPrice)}</span><span class="stat-box-label">Median Sale Price</span></div>
    <div class="stat-box"><span class="stat-box-val">${fmt$(avgPrice)}</span><span class="stat-box-label">Avg Sale Price</span></div>
    <div class="stat-box"><span class="stat-box-val">${fmt$(minP)} ‚Äì ${fmt$(maxP)}</span><span class="stat-box-label">Price Range</span></div>
    ${avgPpsf > 0 ? `<div class="stat-box"><span class="stat-box-val">${fmt$(avgPpsf)}</span><span class="stat-box-label">Avg $/Sq Ft</span></div>` : ''}
    ${subj.subjPrice > 0 ? `<div class="stat-box" style="border-color:${subj.subjPrice <= medPrice ? 'var(--green)' : 'var(--red)'}">
      <span class="stat-box-val" style="color:${subj.subjPrice <= medPrice ? 'var(--green)' : 'var(--red)'}">
        ${subj.subjPrice <= medPrice ? '‚ñº Below' : '‚ñ≤ Above'} Median
      </span>
      <span class="stat-box-label">${fmt$(Math.abs(subj.subjPrice - medPrice))} diff</span>
    </div>` : ''}
  `;

  // Tags
  document.getElementById('tag-row').innerHTML = [
    colMap.sale_date && '<span class="tag">Sale Date ‚úì</span>',
    colMap.sqft && '<span class="tag">Square Feet ‚úì</span>',
    colMap.beds && '<span class="tag">Bedrooms ‚úì</span>',
    colMap.baths && '<span class="tag">Bathrooms ‚úì</span>',
    colMap.prop_class && '<span class="tag">Property Class ‚úì</span>',
    hasDistances && '<span class="tag" style="background:#d4edda;color:var(--green)">üìç Geocoded ‚úì</span>',
  ].filter(Boolean).join('');

  // Columns
  const cols = [
    { key: 'idx',        label: '#',          fn: (r, i) => `<td style="color:var(--muted);font-family:'DM Mono',monospace;font-size:11px">${i+1}</td>`, raw: (r,i) => i },
    { key: 'address',    label: 'Address',    fn: r => `<td class="address-cell">${getFullStreet(r)}</td>`, raw: r => getFullStreet(r) },
    { key: 'city',       label: 'City/Town',  fn: r => `<td>${getVal(r,'city')}</td>`, raw: r => getVal(r,'city') },
    { key: 'distance',   label: 'Distance',   fn: r => {
      if (r._dist === null) return '<td><span class="badge badge-muted">‚Äî</span></td>';
      const d = r._dist;
      const cls = d < 0.15 ? 'dist-close' : d < 0.5 ? 'dist-mid' : 'dist-far';
      return `<td><span class="${cls}">${d < 0.1 ? '<0.1' : d.toFixed(2)} mi</span></td>`;
    }, raw: r => r._dist ?? 999, skip: !hasDistances },
    { key: 'sale_date',  label: 'Sale Date',  fn: r => `<td>${fmtDate(getVal(r,'sale_date'))}</td>`, raw: r => getVal(r,'sale_date'), skip: !colMap.sale_date },
    { key: 'prop_class', label: 'Class',      fn: r => `<td><span class="badge badge-muted">${getVal(r,'prop_class')}</span></td>`, raw: r => getVal(r,'prop_class'), skip: !colMap.prop_class },
    { key: 'sale_price', label: 'Sale Price', fn: r => {
      const p = parsePrice(getVal(r,'sale_price'));
      const diff = subj.subjPrice > 0 ? ((p - subj.subjPrice) / subj.subjPrice * 100).toFixed(1) : null;
      return `<td>${fmt$(p)}${diff !== null ? ` <small class="${parseFloat(diff) < 0 ? 'diff-negative' : 'diff-positive'}">${diff > 0 ? '+' : ''}${diff}%</small>` : ''}</td>`;
    }, raw: r => parsePrice(getVal(r,'sale_price')) },
    { key: 'sqft',       label: 'Sq Ft',      fn: r => { const s = parseFloat(getVal(r,'sqft')); return `<td>${s > 0 ? s.toLocaleString() : '-'}</td>`; }, raw: r => parseFloat(getVal(r,'sqft'))||0, skip: !colMap.sqft },
    { key: 'ppsf',       label: '$/Sq Ft',    fn: r => {
      const p = parsePrice(getVal(r,'sale_price')), s = parseFloat(getVal(r,'sqft'));
      if (!p || !s) return '<td>-</td>';
      const ppsf = p / s;
      const diff = subjPpsf > 0 ? ((ppsf - subjPpsf) / subjPpsf * 100).toFixed(1) : null;
      return `<td>${fmt$(ppsf)}${diff !== null ? ` <small class="${parseFloat(diff) < 0 ? 'diff-negative' : 'diff-positive'}">${diff > 0 ? '+' : ''}${diff}%</small>` : ''}</td>`;
    }, raw: r => { const p=parsePrice(getVal(r,'sale_price')), s=parseFloat(getVal(r,'sqft')); return (p&&s)?p/s:0; }, skip: !colMap.sqft },
    { key: 'beds',       label: 'Beds',       fn: r => `<td>${getVal(r,'beds')||'-'}</td>`, raw: r => getVal(r,'beds'), skip: !colMap.beds },
    { key: 'baths',      label: 'Baths',      fn: r => `<td>${getVal(r,'baths')||'-'}</td>`, raw: r => getVal(r,'baths'), skip: !colMap.baths },
  ].filter(c => !c.skip);

  document.getElementById('table-head').innerHTML = cols.map(c =>
    `<th onclick="sortTable('${c.key}')" class="${sortCol===c.key?'sorted':''}">${c.label} <span class="sort-arrow">${sortCol===c.key?(sortDir>0?'‚ñ≤':'‚ñº'):'‚áÖ'}</span></th>`
  ).join('');

  renderTableRows(comps, cols);
  window._comps = comps; window._cols = cols; window._subj = subj;
}

function renderTableRows(comps, cols) {
  document.getElementById('table-body').innerHTML = comps.map((r, i) =>
    `<tr>${cols.map(c => c.fn(r, i)).join('')}</tr>`
  ).join('');
}

function sortTable(key) {
  if (sortCol === key) sortDir *= -1; else { sortCol = key; sortDir = -1; }
  const col = window._cols.find(c => c.key === key);
  if (!col || !col.raw) return;
  window._comps.sort((a, b) => {
    const av = col.raw(a, 0), bv = col.raw(b, 0);
    if (typeof av === 'number') return (av - bv) * sortDir;
    return String(av).localeCompare(String(bv)) * sortDir;
  });
  renderTableRows(window._comps, window._cols);
  document.getElementById('table-head').innerHTML = window._cols.map(c =>
    `<th onclick="sortTable('${c.key}')" class="${sortCol===c.key?'sorted':''}">${c.label} <span class="sort-arrow">${sortCol===c.key?(sortDir>0?'‚ñ≤':'‚ñº'):'‚áÖ'}</span></th>`
  ).join('');
}

// ‚îÄ‚îÄ‚îÄ EXPORT CSV ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function exportCSV() {
  if (!window._comps) return;
  const cols = window._cols.filter(c => c.key !== 'idx');
  const distCol = window._cols.find(c => c.key === 'distance');
  const allCols = distCol ? cols : cols;
  const header = ['#', ...allCols.map(c => c.label)].join(',');
  const rows = window._comps.map((r, i) =>
    [i+1, ...allCols.map(c => {
      const v = c.raw ? c.raw(r, i) : '';
      return `"${String(v).replace(/"/g,'""')}"`;
    })].join(',')
  );
  const csv = [header, ...rows].join('\n');
  const blob = new Blob([csv], { type: 'text/csv' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `ErieComps_${new Date().toISOString().slice(0,10)}.csv`;
  a.click();
}
</script>
</body>
</html>
